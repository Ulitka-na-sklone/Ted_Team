# Лабораторная работа №3

## Часть 1. Поднятие Postgres
1. Создание и поднятие docker контейнеров:
![image1]()
2. Определение master и slave ноды (master - pg_slave, slave - pg_master)
![image2]()
![image3]()
3. Проверка, что зукипер запустился
![image4]()

## Часть 2. Репликации
4. Подключение к нодам постгреса
![image5]()
![image6]()
5. В ноду лидера кластера (pg_slave) добавляем таблицу и вставляем в неё данные
![image7]()
![image8]()
6. Проверяем, что в pg_master также создалась эта таблица с теми же данными
![image9]()
7. Неудачно пытаемся удалить строчку из таблицы подключения pg_master
![image10]()

## Часть 3. Высокая доступность и HAProxy
8. Перезапускаем docker контейнеры после добавления необходимых конфигурационных файлов и обновления docker-compose.yml для HAProxy
![image11]()
9. Проверяем перераспределение ролей
![image12]()
![image13]()
10. Проверяем Zookiper
![image14]()
11. Создаём подключение к psql_entrypoint (haproxy)
![image15]()
12. Пытаемся заселектить данные из мастер-ноды (получилось!)
![image16]()

## Задание
13. Отключаю мастер-ноду командой `docker stop pg-slave`
14. Наблюдаю за логами pg-master и haproxy. В логах у pg-master замечаю, patroni перераспределил роли, и теперь pg-master является лидером.
![image17]()
![image18]()
15. В entrypont-подключение добавляю новую строчку, которая дублируется и в pg-master
![image19]()
![image20]()

## Ответы на вопросы
1. **Порты 8008 и 5432 вынесены в разные директивы, expose и ports. По сути, если записать 8008 в ports, то он тоже станет exposed. В чем разница?**

Порты в директивах expose доступны только в пределах сети docker compose, а в директивах ports порты будут открыты на хост-машины, и будут доступны извне.

2. **При обычном перезапуске композ-проекта, будет ли сбилден заново образ? А если предварительно отредактировать файлы postgresX.yml? А если содержимое самого Dockerfile? Почему?**

Compose образы не пересобираются, если не используется флаг --build, так как изменения в конфигурации применяются сразу, а изменения в Dockerfile требуют пересборки.
